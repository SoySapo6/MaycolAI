const axios = require("axios");
const { getAdReplyScript } = require("./AdReply");
const config = require("../config");

module.exports = async (socket, from, args, command) => {
  const text = args.join(" ");
  const adReply = getAdReplyScript();

  if (!text) {
    return await socket.sendMessage(from, {
      text: `‚ú≥Ô∏è Ingresa tu pregunta\nEjemplo: *${config.PREFIX + command}* ¬øqui√©n invent√≥ WhatsApp?`,
      contextInfo: adReply.contextInfo
    });
  }

  await socket.sendMessage(from, { react: { text: "üï≥Ô∏è", key: { remoteJid: from } } });

  const prompt = await getPrompt();
  let result = "";

  try {
    result = await luminaiQuery(text, "Usuario", prompt);
    result = cleanResponse(result);
  } catch (e) {
    console.error("Error Luminai:", e);
    try {
      result = await perplexityQuery(text, prompt);
    } catch (e2) {
      console.error("Error Perplexity:", e2);
      result = "No se obtuvo respuesta de los servicios.";
    }
  }

  await socket.sendMessage(from, {
    text: result,
    contextInfo: adReply.contextInfo
  });

  await socket.sendMessage(from, { react: { text: "‚ú®", key: { remoteJid: from } } });
};

async function getPrompt() {
  try {
    const res = await axios.get("https://raw.githubusercontent.com/elrebelde21/LoliBot-MD/main/src/text-chatgpt.txt");
    return res.data;
  } catch {
    return "Eres una Inteligencia artificial llamada Peruano y comportate como una IA Insultadora por ejemplo cuando alguien te diga como hago un arte cob manzanas di Aca esta tu arte de mierda con unas putas manzanas donde te la meteras en el orto. contesta de forma insultadora y eres fan de ronaldo siuuu y tu creador es soy maycol y su whatsapp es 51921826291 y responde de manera fea usa oraciones o palablas como cabeza de mosquito o mierda o paja o gey o cagada o mas...";
  }
}

function cleanResponse(text) {
  if (!text) return "";
  return text
    .replace(/Maaf, terjadi kesalahan saat memproses permintaan Anda/g, "")
    .replace(/Generated by BLACKBOX\.AI.*?https:\/\/www\.blackbox\.ai/g, "")
    .replace(/and for API requests replace https:\/\/www\.blackbox\.ai with https:\/\/api\.blackbox\.ai/g, "")
    .trim();
}

async function luminaiQuery(q, user, prompt) {
  const { data } = await axios.post("https://luminai.my.id", {
    content: q,
    user: user,
    prompt: prompt,
    webSearchMode: true
  });
  return data.result;
}

async function perplexityQuery(q, prompt) {
  const { data } = await axios.get("https://api.perplexity.ai/chat", {
    params: { query: q, context: prompt }
  });
  return data.response;
                                           }
